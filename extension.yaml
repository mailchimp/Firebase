# Copyright 2019 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#    https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: mailchimp-firebase-sync
version: 0.4.0
specVersion: v1beta

displayName: Manage Marketing with Mailchimp
description:
  Syncs user data with a Mailchimp audience for sending personalized email marketing campaigns.

license: Apache-2.0

sourceUrl: https://github.com/mailchimp/Firebase/tree/master/
releaseNotesUrl: https://github.com/mailchimp/Firebase/tree/master/CHANGELOG.md

author:
  authorName: Mailchimp
  url: https://mailchimp.com

contributors:
  - authorName: Lauren Long
    url: https://github.com/laurenzlong
  - authorName: Chris Bianca
    email: chris@csfrequency.com
    url: https://github.com/chrisbianca
  - authorName: Invertase
    email: oss@invertase.io
    url: https://github.com/invertase
  - authorName: Amr Desouky
    email: desoukya@gmail.com
    url: https://github.com/desoukya

billingRequired: true

externalServices:
  - name: Mailchimp
    pricingUri: https://mailchimp.com/pricing

resources:
  - name: addUserToList
    type: firebaseextensions.v1beta.function
    description:
      Listens for new user accounts (as managed by Firebase Authentication),
      then automatically adds the new user to your specified MailChimp audience.
    properties:
      location: ${LOCATION}
      runtime: nodejs16
      eventTrigger:
        eventType: providers/firebase.auth/eventTypes/user.create
        resource: projects/${PROJECT_ID}

  - name: removeUserFromList
    type: firebaseextensions.v1beta.function
    description:
      Listens for existing user accounts to be deleted (as managed by Firebase
      Authentication), then automatically removes them from your specified
      MailChimp audience.
    properties:
      location: ${LOCATION}
      runtime: nodejs16
      eventTrigger:
        eventType: providers/firebase.auth/eventTypes/user.delete
        resource: projects/${PROJECT_ID}

  - name: memberTagsHandler
    type: firebaseextensions.v1beta.function
    description:
      Member Tags provide the ability to associate "metadata" or "labels" with a Mailchimp subscriber.
      The memberTagsHandler function listens for Firestore write events based on specified config path, 
      then automatically classifies the document data as Mailchimp subscriber tags.
    properties:
      location: ${LOCATION}
      runtime: nodejs16
      eventTrigger:
        eventType: providers/cloud.firestore/eventTypes/document.write
        resource: projects/${param:PROJECT_ID}/databases/(default)/documents/${param:MAILCHIMP_MEMBER_TAGS_WATCH_PATH}/{documentId}

  - name: mergeFieldsHandler
    type: firebaseextensions.v1beta.function
    description:
      Merge fields provide the ability to create new properties that can be associated with Mailchimp subscriber.
      The mergeFieldsHandler function listens for Firestore write events based on specified config path, 
      then automatically populates the Mailchimp subscriber's respective merge fields.
    properties:
      location: ${LOCATION}
      runtime: nodejs16
      eventTrigger:
        eventType: providers/cloud.firestore/eventTypes/document.write
        resource: projects/${param:PROJECT_ID}/databases/(default)/documents/${param:MAILCHIMP_MERGE_FIELDS_WATCH_PATH}/{documentId}

  - name: memberEventsHandler
    type: firebaseextensions.v1beta.function
    description:
      Member events are Mailchimp specific activity events that can be created and associated with a predefined action.
      The memberEventsHandler function Listens for Firestore write events based on specified config path, 
      then automatically uses the document data to create a Mailchimp event on the subscriber's profile 
      which can subsequently trigger automation workflows.
    properties:
      location: ${LOCATION}
      runtime: nodejs16
      eventTrigger:
        eventType: providers/cloud.firestore/eventTypes/document.write
        resource: projects/${param:PROJECT_ID}/databases/(default)/documents/${param:MAILCHIMP_MEMBER_EVENTS_WATCH_PATH}/{documentId}

params:
  - param: LOCATION
    label: Cloud Functions location
    description: >-
      Where do you want to deploy the functions created for this extension?
    type: select
    options:
      - label: Iowa (us-central1)
        value: us-central1
      - label: South Carolina (us-east1)
        value: us-east1
      - label: Northern Virginia (us-east4)
        value: us-east4
      - label: Los Angeles (us-west2)
        value: us-west2
      - label: Salt Lake City (us-west3)
        value: us-west3
      - label: Las Vegas (us-west4)
        value: us-west4
      - label: Warsaw (europe-central2)
        value: europe-central2
      - label: Belgium (europe-west1)
        value: europe-west1
      - label: London (europe-west2)
        value: europe-west2
      - label: Frankfurt (europe-west3)
        value: europe-west3
      - label: Zurich (europe-west6)
        value: europe-west6
      - label: Hong Kong (asia-east2)
        value: asia-east2
      - label: Tokyo (asia-northeast1)
        value: asia-northeast1
      - label: Osaka (asia-northeast2)
        value: asia-northeast2
      - label: Seoul (asia-northeast3)
        value: asia-northeast3
      - label: Mumbai (asia-south1)
        value: asia-south1
      - label: Jakarta (asia-southeast2)
        value: asia-southeast2
      - label: Montreal (northamerica-northeast1)
        value: northamerica-northeast1
      - label: Sao Paulo (southamerica-east1)
        value: southamerica-east1
      - label: Sydney (australia-southeast1)
        value: australia-southeast1
    default: us-central1
    required: true
    immutable: true

  - param: MAILCHIMP_API_KEY
    label: Mailchimp OAuth Token
    description: >-
      To obtain a Mailchimp OAuth Token, click
      [here](https://firebase.mailchimp.com/index.html).
    type: string
    example: a1b2c3d4e5f6g7
    required: true

  - param: MAILCHIMP_AUDIENCE_ID
    label: Audience ID
    description: >-
      What is the Mailchimp Audience ID to which you want to subscribe new
      users? To find your Audience ID: visit https://admin.mailchimp.com/lists,
      click on the desired audience or create a new audience, then select
      **Settings**. Look for **Audience ID** (for example, `27735fc60a`).
    type: string
    example: 1ab2345c67
    required: true

  - param: MAILCHIMP_CONTACT_STATUS
    label: Contact status
    description: >-
      When the extension adds a new user to the Mailchimp audience, what is
      their initial status? This value can be `subscribed` or `pending`.
      `subscribed` means the user can receive campaigns; `pending` means the
      user still needs to opt-in to receive campaigns.
    type: select
    options:
      - label: Subscribed
        value: subscribed
      - label: Pending
        value: pending
    default: subscribed
    required: true

  - param: MAILCHIMP_MEMBER_TAGS_WATCH_PATH
    label: Firebase Member Tags Watch Path
    description: The Firestore collection to watch for member tag changes
    type: string
    example: registrations
    default: _unused_
    required: true

  - param: MAILCHIMP_MEMBER_TAGS_CONFIG
    type: string
    label: Firebase Member Tags Config
    description: >-
      Provide a configuration mapping in JSON format indicating which Firestore event(s) to listen for and associate as Mailchimp member tags.


      Required Fields:

      1) `memberTags` - The Firestore document fields(s) to retrieve data from and classify as subscriber tags in Mailchimp. Acceptable data types include:
      
      - Array\<String\> - The extension will lookup the values in the provided fields and update the subscriber's member tags with the respective data values.


      - String - The extension will lookup the value in the provided field and update the subscriber's member tags with the provided value.


      2) `subscriberEmail` - The Firestore document field capturing the user email as is recognized by Mailchimp


      Configuration Example:

      ```
      {
        "memberTags": ["domainKnowledge", "jobTitle"],
        "subscriberEmail": "emailAddress"
      }
      ```


      Based on the sample configuration, if the following Firestore document is provided: 
      
      ```
      {
        "firstName": "..",
        "lastName": "..",
        "phoneNumber": "..",
        "courseName": "..",
        "emailAddress": "..", // The config property 'subscriberEmail' maps to this document field
        "jobTitle": "..", // The config property 'memberTags' maps to this document field
        "domainKnowledge": "..", // The config property 'memberTags' maps to this document field
        "activity": []
      }
      ```


      Any data associated with the mapped fields will be considered Member Tags and the Mailchimp user's profile will be updated accordingly.


      NOTE: To disable this cloud function listener, provide an empty JSON config `{}`.


    required: true
    default: '{}'

  - param: MAILCHIMP_MERGE_FIELDS_WATCH_PATH
    label: Firebase Merge Fields Watch Path
    description: The Firestore collection to watch for merge field changes
    type: string
    example: registrations
    default: _unused_
    required: true    

  - param: MAILCHIMP_MERGE_FIELDS_CONFIG
    type: string
    label: Firebase Merge Fields Config
    description: >-
      Provide a configuration mapping in JSON format indicating which Firestore event(s) to listen for and associate as Mailchimp merge fields.


      Required Fields:

      1) `mergeFields` - JSON mapping representing the Firestore document fields to associate with Mailchimp Merge Fields.


      2) `subscriberEmail` - The Firestore document field capturing the user email as is recognized by Mailchimp


      Configuration Example:

      ```
      {
        "mergeFields": {
          "firstName": "FNAME",
          "lastName": "LNAME",
          "phoneNumber": "PHONE"
        },
        "subscriberEmail": "emailAddress"
      }
      ```


      Based on the sample configuration, if the following Firestore document is provided: 

      ```
      {
        "firstName": "..", // The config property FNAME maps to this document field
        "lastName": "..", // The config property LNAME maps to this document field
        "phoneNumber": "..", // The config property PHONE maps to this document field
        "emailAddress": "..", // The config property "subscriberEmail" maps to this document field
        "jobTitle": "..", 
        "domainKnowledge": "..",
        "activity": []
      }
      ```


      Any data associated with the mapped fields will be considered Merge Fields and the Mailchimp user's profile will be updated accordingly.


      NOTE: To disable this cloud function listener, provide an empty JSON config `{}`.


    required: true
    default: '{}'

  - param: MAILCHIMP_MEMBER_EVENTS_WATCH_PATH
    label: Firebase Member Events Watch Path
    description: The Firestore collection to watch for member event changes
    type: string
    example: registrations
    default: _unused_
    required: true

  - param: MAILCHIMP_MEMBER_EVENTS_CONFIG
    type: string
    label: Firebase Member Events Config
    description: >-
      Provide a configuration mapping in JSON format indicating which Firestore event(s) to listen for and associate as Mailchimp merge events.


      Required Fields:

      1) `memberEvents` - The Firestore document fields(s) to retrieve data from and classify as member events in Mailchimp. Acceptable data types include:
      
      - Array\<String\> - The extension will lookup the values (mailchimp event names) in the provided fields and post those events to Mailchimp on the subscriber's activity feed.


      - String - The extension will lookup the value (mailchimp event name) in this specific field and post the event to Mailchimp on the subscriber's activity feed.


      2) `subscriberEmail` - The Firestore document field capturing the user email as is recognized by Mailchimp


      Configuration Example:

      ```
      {
        "memberEvents": [
          "activity"
        ],
        "subscriberEmail": "emailAddress"
      }
      ```


      Based on the sample configuration, if the following Firestore document is provided: 
      
      ```
      {
        "firstName": "..",
        "lastName": "..",
        "phoneNumber": "..",
        "courseName": "..",
        "jobTitle": "..", 
        "domainKnowledge": "..",
        "emailAddress": "..", // The config property "subscriberEmail" maps to this document field
        "activity": ["send_welcome_email"] // The config property "memberTags" maps to this document field
      }
      ```


      Any data associated with the mapped fields will be considered Merge Fields and the Mailchimp user's profile will be updated accordingly.


      NOTE: To disable this cloud function listener, provide an empty JSON config `{}`.


    required: true
    default: '{}'
